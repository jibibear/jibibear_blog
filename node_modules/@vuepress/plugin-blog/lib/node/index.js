import{Logger as G,isFunction as C,isString as D,removeLeadingSlash as S,fromEntries as j,entries as z,addViteSsrNoExternal as W,getPageExcerpt as q}from"@vuepress/helper";import{watch as K}from"chokidar";import{createPage as U,preparePageComponent as Q,preparePageChunk as X,prepareRoutes as Y}from"vuepress/core";import{sanitizeFileName as Z,colors as h}from"vuepress/utils";const H="@vuepress/plugin-blog",l=new G(H),L=t=>encodeURI(t.split("/").map(Z).join("/")),B=(t,e,p,o,u)=>{const O=p.map(({key:n,getter:d,sorter:v=()=>-1,path:b="/:key/",layout:E="Layout",frontmatter:I=()=>({}),itemPath:m="/:key/:name/",itemLayout:k="Layout",itemFrontmatter:_=()=>({})})=>{u&&l.info(`Generating ${h.cyan(n)} category.
`);const M=C(m)?m:D(m)?g=>m.replace(/:key/g,o(n)).replace(/:name/g,o(g)):()=>null,c={},$=[];for(const g in t){if(b){const r=`${g}${S(b.replace(/:key/g,o(n)))}`;$.push({path:r,frontmatter:{...I(g),blog:{type:"category",key:n},layout:E}}),c[g]={path:L(r),map:{}}}else c[g]={path:"",map:{}};const{map:a}=c[g],f={};for(const r of t[g]){const s=d(r);for(const i of s){if(!(i in a)){const w=M(i);if(w){const R=`${g}${S(w)}`;$.push({path:R,frontmatter:{..._(i,g),blog:{type:"category",name:i,key:n},layout:k}}),a[i]={path:L(R),indexes:[]}}else a[i]={path:"",indexes:[]};f[i]=[]}f[i].push(r)}}for(const r in f)a[r].indexes=e.addItems(f[r].sort(v).map(({path:s})=>s));if(u){let r=`${n} category in locale ${g}:
`;for(const s in a){const{path:i,indexes:w}=a[s];r+=`${s}: found ${w.length} items${i?` in path: ${i}`:""}
`}l.info(r)}}return{key:n,categoryMap:c,pageOptions:$}});return{categoriesMap:j(O.map(({key:n,categoryMap:d})=>[n,d])),pageOptions:O.map(({pageOptions:n})=>n).flat()}},ee=t=>t.filter(({key:e,getter:p},o)=>!D(e)||!e?(l.error(`Invalid ${h.magenta("key")} option ${h.cyan(e)} in ${h.cyan(`category[${o}]`)}`),!1):C(p)?!0:(l.error(`Invalid ${h.magenta("getter")} option in "${h.cyan(`category[${o}]`)}", it should be a function!`),!1)),te=`
if (import.meta.webpackHot) {
  import.meta.webpackHot.accept();
  if (__VUE_HMR_RUNTIME__.updateBlogCategory)
    __VUE_HMR_RUNTIME__.updateBlogCategory(categoriesMap);
}

if (import.meta.hot)
  import.meta.hot.accept(({ categoriesMap }) => {
    __VUE_HMR_RUNTIME__.updateBlogCategory(categoriesMap);
  });
`,V=async(t,e)=>{await t.writeTemp("blog/category.js",`export const categoriesMap = ${JSON.stringify(e)};
${t.env.isDev?te:""}
`)},F=(t,e)=>{const p={"/":[],...Object.fromEntries(Object.keys(t.siteData.locales).map(o=>[o,[]]))};return t.pages.filter(o=>e(o)&&o.path.substring(o.pathLocale.length-1)!=="/404.html").forEach(o=>{p[o.pathLocale].push(o)}),p};class ae{store;constructor(){this.store=[]}addItem(e){const p=this.store.indexOf(e);return p===-1?(this.store.push(e),this.store.length-1):p}addItems(e){return e.map(p=>this.addItem(p))}clearItem(e){const p=this.store.indexOf(e);p!==-1&&(this.store[p]="")}toJSON(){return JSON.stringify(this.store)}}const oe=async(t,e)=>{await t.writeTemp("blog/store.js",`export const store = ${e.toJSON()};
`)},J=(t,e,p,o,u=!1)=>{const O=p.map(({key:n,sorter:d=()=>-1,filter:v=()=>!0,path:b="/:key/",layout:E="Layout",frontmatter:I=()=>({})})=>{u&&l.info(`Generating ${h.cyan(n)} type.
`);const m=[],k={};return z(t).forEach(([_,M])=>{const c=b?`${_}${S(b.replace(/:key/g,o(n)))}`:"",$=e.addItems(M.filter(v).sort(d).map(({path:g})=>g));c&&m.push({path:c,frontmatter:{...I(_),blog:{type:"type",key:n},layout:E}}),u&&l.info(`${n} type in locale ${_}: found ${$.length} items
`),k[_]={path:L(c),indexes:$}}),{key:n,typeMap:k,pageOptions:m}});return{typesMap:j(O.map(({key:n,typeMap:d})=>[n,d])),pageOptions:O.map(({pageOptions:n})=>n).flat()}},ne=t=>t.filter((e,p)=>{const{key:o}=e;return!D(o)||!o?(l.error(`Invalid ${h.magenta("key")} option ${h.cyan(o)} in ${h.cyan(`type[${p}]`)}`),!1):!0}),pe=`
if (import.meta.webpackHot) {
  import.meta.webpackHot.accept();
  if (__VUE_HMR_RUNTIME__.updateBlogType)
    __VUE_HMR_RUNTIME__.updateBlogType(typesMap);
}

if (import.meta.hot)
  import.meta.hot.accept(({ typesMap }) => {
    __VUE_HMR_RUNTIME__.updateBlogType(typesMap);
  });
`,A=async(t,e)=>{await t.writeTemp("blog/type.js",`export const typesMap = ${JSON.stringify(e)};
${t.env.isDev?pe:""}
`)},re=t=>e=>{e.env.isDebug&&l.info("Options:",t);const{getInfo:p=()=>({}),filter:o=a=>!!a.filePathRelative&&!a.frontmatter.home,metaScope:u="_blog",excerpt:O=!0,excerptSeparator:n="<!-- more -->",excerptLength:d=300,excerptFilter:v=o,isCustomElement:b=()=>!1,category:E=[],type:I=[],slugify:m=a=>a.replace(/[ _]/g,"-").replace(/[:?*|\\/<>]/g,"").toLowerCase()}=t,k=ee(E),_=ne(I),M=new ae;let c=[],$={},g={};return{name:H,define:()=>({__BLOG_META_SCOPE__:u}),extendsBundlerOptions:a=>{W(a,e,"@vuepress/helper")},extendsPage:a=>{O&&v(a)&&!a.data.excerpt&&(a.data.excerpt=q(e,a,{isCustomElement:b,separator:n,length:d})),o(a)&&(a.routeMeta={...u===""?p(a):{[u]:p(a)},...a.routeMeta})},onInitialized:async()=>{const a=F(e,o),f=B(a,M,k,m,e.env.isDebug),r=J(a,M,_,m,e.env.isDebug);await Promise.all([...f.pageOptions,...r.pageOptions].map(async s=>{if(e.pages.findIndex(i=>i.path===s.path)!==-1){l.warn("Overriding existing page:",s.path);const i=e.pages.findIndex(w=>w.path===s.path);e.pages.splice(i,1,await U(e,s))}e.pages.push(await U(e,s))})),c=[...f.pageOptions,...r.pageOptions].map(s=>s.path),$=f.categoriesMap,g=r.typesMap},onPrepared:async()=>{await oe(e,M),await V(e,$),await A(e,g),e.env.isDebug&&l.info("temp file generated")},onWatched:(a,f)=>{if("hotReload"in t?t.hotReload:e.env.isDebug){const r=K("pages/**/*.js",{cwd:e.dir.temp(),ignoreInitial:!0}),s=async()=>{const i=F(e,o),w=B(i,M,k,m,e.env.isDebug),R=J(i,M,_,m,e.env.isDebug),N=[...w.pageOptions,...R.pageOptions];await V(e,w.categoriesMap),await A(e,R.typesMap);const P=N.filter(y=>!c.includes(y.path)),T=c.filter(y=>N.every(x=>x.path!==y));P.length&&(e.env.isDebug&&l.info(`Adding new pages: ${P.map(({path:y})=>y).join(", ")}`),await Promise.all(P.map(async y=>{const x=await U(e,y);await Q(e,x),await X(e,x),e.pages.push(x)}))),T.length&&(e.env.isDebug&&l.info(`Removing following pages: ${T.join(", ")}`),T.forEach(y=>{e.pages.splice(e.pages.findIndex(({path:x})=>x===y),1)})),(T.length||P.length)&&await Y(e),c=N.map(y=>y.path),e.env.isDebug&&l.info("temp file updated")};r.on("add",()=>{s()}),r.on("change",()=>{s()}),r.on("unlink",()=>{s()}),f.push(r)}}}};export{re as blogPlugin};
//# sourceMappingURL=index.js.map
