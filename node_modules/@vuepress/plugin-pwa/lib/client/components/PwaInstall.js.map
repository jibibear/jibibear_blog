{"version":3,"file":"PwaInstall.js","sources":["../../../src/client/components/PwaInstallModal.ts","../../../src/client/components/PwaInstall.ts"],"sourcesContent":["/* eslint-disable no-console */\nimport { useLocaleConfig } from '@vuepress/helper/client'\nimport { useEventListener } from '@vueuse/core'\nimport type { PropType, VNode } from 'vue'\nimport { defineComponent, h, onMounted, shallowRef } from 'vue'\nimport { withBase } from 'vuepress/client'\nimport type { AppManifest } from '../../shared/index.js'\nimport type { PwaPluginLocaleConfig } from '../types.js'\nimport { ArrowLeftIcon, ArrowRightIcon, CloseIcon } from './icons.js'\n\ninterface InstallPromptEvent extends Event {\n  readonly platforms: string\n  prompt: () => void\n  readonly userChoice: Promise<{ outcome: 'accepted' | 'dismissed' }>\n}\n\nexport const PwaInstallModal = defineComponent({\n  name: 'PwaInstallModal',\n\n  props: {\n    /** locale data */\n    locales: {\n      type: Object as PropType<PwaPluginLocaleConfig>,\n      required: true,\n    },\n\n    /**\n     * Whether use hint message instead of showing a button\n     *\n     * 是否使用提示\n     */\n    useHint: Boolean,\n  },\n\n  emits: ['canInstall', 'hint', 'close'],\n\n  setup(props, { emit }) {\n    const locale = useLocaleConfig(props.locales)\n\n    const manifest = shallowRef<AppManifest>({})\n    const deferredPrompt = shallowRef<InstallPromptEvent>()\n\n    const getManifest = async (): Promise<void> => {\n      const manifestContent = localStorage.getItem('manifest')\n\n      if (manifestContent)\n        manifest.value = JSON.parse(manifestContent) as AppManifest\n      else\n        try {\n          const response = await fetch(withBase('manifest.webmanifest'))\n          const data = (await response.json()) as AppManifest\n\n          manifest.value = data\n          localStorage.setItem('manifest', JSON.stringify(data))\n        } catch {\n          console.error(\n            '[PWA]: Error getting manifest, check that you have a valid web manifest or network connection',\n          )\n        }\n    }\n\n    const scrollToLeft = (): void => {\n      const screenshotsDiv = document.querySelector('.screenshot')\n\n      if (screenshotsDiv)\n        screenshotsDiv.scrollBy({\n          left: -screenshotsDiv.clientWidth,\n          top: 0,\n          behavior: 'smooth',\n        })\n    }\n\n    const scrollToRight = (): void => {\n      const screenshotsDiv = document.querySelector('.screenshot')\n\n      if (screenshotsDiv)\n        screenshotsDiv.scrollBy({\n          left: screenshotsDiv.clientWidth,\n          top: 0,\n          behavior: 'smooth',\n        })\n    }\n\n    const install = async (): Promise<void> => {\n      if (deferredPrompt.value) {\n        deferredPrompt.value.prompt()\n\n        document.dispatchEvent(new CustomEvent('show'))\n\n        const choiceResult = await deferredPrompt.value.userChoice\n\n        if (choiceResult.outcome === 'accepted') {\n          console.info('PWA has been installed')\n\n          emit('close', false)\n          emit('canInstall', false)\n        } else {\n          console.info('You choose to not install PWA')\n\n          emit('close', false)\n          emit('canInstall', false)\n        }\n      }\n    }\n\n    const hint = (): void => {\n      console.info('You accepted the install hint')\n      emit('hint')\n    }\n\n    onMounted(() => {\n      // eslint-disable-next-line no-prototype-builtins\n      if (window.hasOwnProperty('BeforeInstallPromptEvent')) {\n        useEventListener(window, 'beforeinstallprompt', (event) => {\n          deferredPrompt.value = event as InstallPromptEvent\n\n          emit('canInstall', true)\n          event.preventDefault()\n        })\n\n        useEventListener('keyup', (event): void => {\n          if (event.key === 'Escape') emit('close', false)\n        })\n\n        void getManifest()\n      }\n    })\n\n    return (): VNode =>\n      h('div', { id: 'install-modal-wrapper' }, [\n        h('div', {\n          class: 'background',\n          onClick: () => {\n            emit('close', false)\n          },\n        }),\n\n        h('div', { class: 'install-modal' }, [\n          h('div', { class: 'header' }, [\n            // close button\n            h(\n              'button',\n              {\n                'type': 'button',\n                'class': 'close-button',\n                'aria-label': locale.value.close,\n                'onClick': () => {\n                  emit('close', false)\n                },\n              },\n              h(CloseIcon),\n            ),\n\n            h('div', { class: 'logo' }, [\n              manifest.value.icons\n                ? h('img', {\n                    src: manifest.value.icons[0]?.src,\n                    alt: 'App Logo',\n                  })\n                : null,\n              h('div', { class: 'title' }, [\n                h('h1', manifest.value.short_name || manifest.value.name),\n                h('p', { class: 'desc' }, locale.value.explain),\n              ]),\n            ]),\n          ]),\n\n          h('div', { class: 'content' }, [\n            h('div', { class: 'highlight' }, [\n              manifest.value.features\n                ? h('div', { class: 'feature-wrapper' }, [\n                    h('h3', locale.value.feature),\n                    h(\n                      'ul',\n                      manifest.value.features.map((feature) =>\n                        h('li', feature),\n                      ),\n                    ),\n                  ])\n                : null,\n\n              manifest.value.screenshots\n                ? h('div', { class: 'screenshot-wrapper' }, [\n                    h(\n                      'button',\n                      {\n                        'type': 'button',\n                        'aria-label': locale.value.prevImage,\n                        'onClick': scrollToLeft,\n                      },\n                      h(ArrowLeftIcon),\n                    ),\n                    h('section', { class: 'screenshot' }, [\n                      manifest.value.screenshots.map((screenshot) =>\n                        h(\n                          'div',\n                          h('img', {\n                            src: screenshot.src,\n                            alt: 'App Screenshot',\n                          }),\n                        ),\n                      ),\n                    ]),\n                    h(\n                      'button',\n                      {\n                        'type': 'button',\n                        'aria-label': locale.value.nextImage,\n                        'onClick': scrollToRight,\n                      },\n                      h(ArrowRightIcon),\n                    ),\n                  ])\n                : null,\n            ]),\n\n            h('div', { class: 'description' }, [\n              h('h3', locale.value.desc),\n              h('p', manifest.value.description),\n            ]),\n          ]),\n\n          props.useHint\n            ? h('div', { class: 'ios-text', onClick: hint }, [\n                h('p', locale.value.iOSInstall),\n                h('button', { type: 'button', class: 'success' }, 'Got it!'),\n              ])\n            : h('div', { class: 'button-wrapper' }, [\n                h(\n                  'button',\n                  { type: 'button', class: 'install-button', onClick: install },\n                  [locale.value.install, h('span', manifest.value.short_name)],\n                ),\n                h(\n                  'button',\n                  {\n                    type: 'button',\n                    class: 'cancel-button',\n                    onClick: () => {\n                      emit('close', false)\n                    },\n                  },\n                  locale.value.cancel,\n                ),\n              ]),\n        ]),\n      ])\n  },\n})\n","import { useLocaleConfig } from '@vuepress/helper/client'\nimport { useToggle } from '@vueuse/core'\nimport type { PropType, VNode } from 'vue'\nimport { computed, defineComponent, h, onMounted, ref } from 'vue'\nimport type { ManifestExternalApplicationResource } from '../../shared/index.js'\nimport type { PwaPluginLocaleConfig } from '../types.js'\nimport { PwaInstallModal } from './PwaInstallModal.js'\n\nimport '../styles/modal.css'\n\ninterface ModernNavigator extends Navigator {\n  // Nonstandard Api\n  getInstalledRelatedApps: () => Promise<ManifestExternalApplicationResource[]>\n}\n\ninterface SafariNavigator extends Navigator {\n  // Available on Apple’s iOS Safari only.\n  standalone: boolean\n}\n\nexport const PwaInstall = defineComponent({\n  name: 'PwaInstall',\n\n  props: {\n    /** locale data */\n    locales: {\n      type: Object as PropType<PwaPluginLocaleConfig>,\n      required: true,\n    },\n  },\n\n  setup(props) {\n    const locale = useLocaleConfig(props.locales)\n    const [isOpen, toggleIsOpen] = useToggle(false)\n\n    const canInstall = ref(false)\n    const hasRelatedApps = ref(false)\n    const isIOS = ref(false)\n    const isSafari = ref(false)\n    const hinted = ref(false)\n\n    const useHint = computed(\n      () => isIOS.value && isSafari.value && !hinted.value,\n    )\n\n    const showInstall = computed(\n      () => (hasRelatedApps.value && canInstall.value) || useHint.value,\n    )\n\n    const getInstallStatus = (): boolean => {\n      if ((navigator as SafariNavigator).standalone)\n        return (navigator as SafariNavigator).standalone\n\n      return matchMedia('(display-mode: standalone)').matches\n    }\n\n    const hint = (): void => {\n      toggleIsOpen(false)\n      hinted.value = true\n      // do not notify again\n      localStorage.setItem('iOS-pwa-hint', 'hinted')\n    }\n\n    onMounted(() => {\n      if (getInstallStatus()) {\n        const { userAgent } = navigator\n\n        // handle iOS specifically\n        isIOS.value =\n          // regular iPhone\n          userAgent.includes('iPhone') ||\n          // regular iPad\n          userAgent.includes('iPad') ||\n          // iPad pro\n          Boolean(\n            userAgent.includes('Macintosh') &&\n              navigator.maxTouchPoints &&\n              navigator.maxTouchPoints > 2,\n          )\n\n        isSafari.value =\n          navigator.userAgent.includes('Safari') &&\n          !userAgent.includes('Chrome')\n\n        hinted.value = Boolean(localStorage.getItem('iOS-pwa-hint'))\n      }\n\n      if ('getInstalledRelatedApps' in (navigator as ModernNavigator))\n        void (navigator as ModernNavigator)\n          .getInstalledRelatedApps()\n          .then((result) => {\n            hasRelatedApps.value = result.length > 0\n          })\n    })\n\n    return (): VNode =>\n      h('div', { id: 'pwa-install' }, [\n        showInstall.value\n          ? h(\n              'button',\n              {\n                type: 'button',\n                class: 'modal-button',\n                onClick: () => {\n                  toggleIsOpen(true)\n                },\n              },\n              locale.value.install,\n            )\n          : null,\n        h(PwaInstallModal, {\n          style: {\n            display: isOpen.value ? 'block' : 'none',\n          },\n          locales: props.locales,\n          useHint: useHint.value,\n          onCanInstall: (value: boolean) => {\n            canInstall.value = value\n          },\n          onHint: () => {\n            hint()\n          },\n          onClose: () => toggleIsOpen(false),\n        }),\n      ])\n  },\n})\n"],"names":["PwaInstallModal","defineComponent","props","emit","locale","useLocaleConfig","manifest","shallowRef","deferredPrompt","getManifest","manifestContent","data","withBase","scrollToLeft","screenshotsDiv","scrollToRight","install","hint","onMounted","useEventListener","event","h","CloseIcon","feature","ArrowLeftIcon","screenshot","ArrowRightIcon","PwaInstall","isOpen","toggleIsOpen","useToggle","canInstall","ref","hasRelatedApps","isIOS","isSafari","hinted","useHint","computed","showInstall","getInstallStatus","userAgent","result","value"],"mappings":"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"}