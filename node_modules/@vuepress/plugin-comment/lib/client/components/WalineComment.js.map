{"version":3,"file":"WalineComment.js","sources":["../../../src/client/components/WalineComment.ts"],"sourcesContent":["import type { ExactLocaleConfig } from '@vuepress/helper/client'\nimport { LoadingIcon, useLocaleConfig, wait } from '@vuepress/helper/client'\nimport { watchImmediate } from '@vueuse/core'\nimport { pageviewCount } from '@waline/client/pageview'\nimport type { VNode } from 'vue'\nimport {\n  computed,\n  defineAsyncComponent,\n  defineComponent,\n  h,\n  nextTick,\n  onMounted,\n} from 'vue'\nimport { ClientOnly, usePageFrontmatter, usePageLang } from 'vuepress/client'\nimport type {\n  CommentPluginFrontmatter,\n  WalineLocaleData,\n} from '../../shared/index.js'\nimport { useWalineOptions } from '../helpers/index.js'\n\nimport '@waline/client/waline.css'\nimport '../styles/waline.css'\n\ndeclare const WALINE_META: boolean\ndeclare const WALINE_LOCALES: ExactLocaleConfig<WalineLocaleData>\n\nconst walineLocales = WALINE_LOCALES\n\nif (WALINE_META)\n  void import(/* webpackChunkName: \"waline\" */ '@waline/client/waline-meta.css')\n\nexport default defineComponent({\n  name: 'WalineComment',\n\n  props: {\n    /**\n     * The path of the comment\n     */\n    identifier: {\n      type: String,\n      required: true,\n    },\n  },\n\n  setup(props) {\n    const walineOptions = useWalineOptions()\n    const frontmatter = usePageFrontmatter<CommentPluginFrontmatter>()\n    const lang = usePageLang()\n    const walineLocale = useLocaleConfig(walineLocales)\n\n    let abort: (() => void) | null = null\n    const enableWaline = computed(() => Boolean(walineOptions.value.serverURL))\n\n    const enablePageViews = computed(() => {\n      if (!enableWaline.value) return false\n      const pluginConfig = walineOptions.value.pageview !== false\n      const pageConfig = frontmatter.value.pageview\n\n      return (\n        // Enable in page\n        Boolean(pageConfig) ||\n        // Not disabled in anywhere\n        (pluginConfig && pageConfig !== false)\n      )\n    })\n\n    const walineProps = computed(() => ({\n      lang: lang.value === 'zh-CN' ? 'zh-CN' : 'en',\n      locale: walineLocale.value,\n      dark: \"[data-theme='dark']\",\n      ...walineOptions.value,\n      path: props.identifier,\n    }))\n\n    onMounted(() => {\n      watchImmediate(\n        () => [\n          props.identifier,\n          walineOptions.value.serverURL,\n          walineOptions.value.delay,\n          enablePageViews.value,\n        ],\n        async () => {\n          abort?.()\n          abort = null\n\n          if (enablePageViews.value) {\n            await nextTick()\n            await wait(walineOptions.value.delay ?? 800)\n\n            abort = pageviewCount({\n              serverURL: walineOptions.value.serverURL,\n              path: props.identifier,\n            })\n          }\n        },\n      )\n    })\n\n    return (): VNode | null =>\n      enableWaline.value\n        ? h(\n            'div',\n            { id: 'comment', class: 'waline-wrapper' },\n            h(\n              defineAsyncComponent({\n                loader: async () => {\n                  const { Waline } = await import(\n                    /* webpackChunkName: \"waline\" */ '@waline/client/component'\n                  )\n\n                  return () => h(ClientOnly, () => h(Waline, walineProps.value))\n                },\n                loadingComponent: LoadingIcon,\n              }),\n            ),\n          )\n        : null\n  },\n})\n"],"names":["walineLocales","defineComponent","props","walineOptions","useWalineOptions","frontmatter","usePageFrontmatter","lang","usePageLang","walineLocale","useLocaleConfig","abort","enableWaline","computed","enablePageViews","pluginConfig","pageConfig","walineProps","onMounted","watchImmediate","nextTick","wait","pageviewCount","h","defineAsyncComponent","Waline","ClientOnly","LoadingIcon"],"mappings":"2eA0BA,MAAMA,EAAgB,eAElB,aACG,OAAwC,gCAAgC,EAE/E,MAAeC,EAAgB,CAC7B,KAAM,gBAEN,MAAO,CAIL,WAAY,CACV,KAAM,OACN,SAAU,EACZ,CACF,EAEA,MAAMC,EAAO,CACX,MAAMC,EAAgBC,EAAAA,EAChBC,EAAcC,EAA6C,EAC3DC,EAAOC,EAAAA,EACPC,EAAeC,EAAgBV,CAAa,EAElD,IAAIW,EAA6B,KACjC,MAAMC,EAAeC,EAAS,IAAM,EAAQV,EAAc,MAAM,SAAU,EAEpEW,EAAkBD,EAAS,IAAM,CACrC,GAAI,CAACD,EAAa,MAAO,MAAO,GAChC,MAAMG,EAAeZ,EAAc,MAAM,WAAa,GAChDa,EAAaX,EAAY,MAAM,SAErC,MAEE,CAAA,CAAQW,GAEPD,GAAgBC,IAAe,EAEpC,CAAC,EAEKC,EAAcJ,EAAS,KAAO,CAClC,KAAMN,EAAK,QAAU,QAAU,QAAU,KACzC,OAAQE,EAAa,MACrB,KAAM,sBACN,GAAGN,EAAc,MACjB,KAAMD,EAAM,UACd,EAAE,EAEF,OAAAgB,EAAU,IAAM,CACdC,EACE,IAAM,CACJjB,EAAM,WACNC,EAAc,MAAM,UACpBA,EAAc,MAAM,MACpBW,EAAgB,KAClB,EACA,SAAY,CACVH,IAAAA,EACAA,EAAQ,KAEJG,EAAgB,QAClB,MAAMM,EAAS,EACf,MAAMC,EAAKlB,EAAc,MAAM,OAAS,GAAG,EAE3CQ,EAAQW,EAAc,CACpB,UAAWnB,EAAc,MAAM,UAC/B,KAAMD,EAAM,UACd,CAAC,EAEL,CACF,CACF,CAAC,EAEM,IACLU,EAAa,MACTW,EACE,MACA,CAAE,GAAI,UAAW,MAAO,gBAAiB,EACzCA,EACEC,EAAqB,CACnB,OAAQ,SAAY,CAClB,KAAM,CAAE,OAAAC,CAAO,EAAI,KAAM,QACU,0BACnC,EAEA,MAAO,IAAMF,EAAEG,EAAY,IAAMH,EAAEE,EAAQR,EAAY,KAAK,CAAC,CAC/D,EACA,iBAAkBU,CACpB,CAAC,CACH,CACF,EACA,IACR,CACF,CAAC"}